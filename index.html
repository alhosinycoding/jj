<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أكاديمية الشهد | المنصة الذكية</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --primary: #fb923c;
            --primary-dark: #f97316;
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            scroll-behavior: smooth;
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section { display: none; animation: slideUp 0.5s ease-out; }
        .section.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .nav-link.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        
        /* Neumorphic Buttons */
        .btn-neo {
            background: var(--primary);
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
            transition: all 0.3s ease;
        }
        .btn-neo:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(251, 146, 60, 0.5); }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="loadingOverlay" class="fixed inset-0 z-[3000] bg-slate-950 flex flex-col items-center justify-center hidden">
        <div class="loader mb-4"></div>
        <p class="text-orange-400 font-bold animate-pulse">جاري تحديث البيانات...</p>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[2000] glass px-6 py-3 rounded-full text-white shadow-2xl hidden border-orange-500/50"></div>

    <nav class="fixed top-0 w-full z-[1000] glass border-b border-white/5 px-4 md:px-12 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://i.postimg.cc/qBNWWK9h/file-00000000b6f0724699170c32f51055fb-(1).png" class="h-10 md:h-12 hover:scale-105 transition" alt="Logo">
            <span class="hidden md:block font-extrabold text-xl tracking-tighter">أكاديمية <span class="text-orange-500">الشهد</span></span>
        </div>
        
        <div id="navItems" class="hidden md:flex gap-8 font-bold text-slate-300">
            </div>

        <div class="flex items-center gap-4">
            <button id="userTag" class="hidden md:flex items-center gap-2 glass px-4 py-2 rounded-xl text-sm border-orange-500/20">
                <i class="fa-solid fa-circle-user text-orange-500"></i>
                <span id="navUserName"></span>
            </button>
            <button onclick="toggleMobileMenu()" class="md:hidden text-2xl"><i class="fa-solid fa-bars-staggered"></i></button>
        </div>
    </nav>

    <main class="pt-28 pb-12 px-4 md:px-12 max-w-7xl mx-auto">

        <section id="landing" class="section active">
            <div class="grid md:grid-cols-2 gap-12 items-center min-h-[70vh]">
                <div>
                    <h1 class="text-5xl md:text-7xl font-extrabold leading-tight mb-6 text-white">طريقك نحو <br><span class="text-orange-500 italic">التفوق</span> يبدأ هنا</h1>
                    <p class="text-slate-400 text-lg mb-8 leading-relaxed">أهلاً بك في منصة الأستاذ محمد عبد العزيز. استمتع بتجربة تعليمية فريدة تعتمد على أحدث التقنيات لمتابعة مستواك الدراسي لحظة بلحظة.</p>
                    <div class="flex gap-4">
                        <button onclick="showSection('login')" class="btn-neo px-8 py-4 rounded-2xl font-bold text-white">ابدأ رحلتك الآن</button>
                        <button onclick="window.open('https://wa.me/201277723926')" class="glass px-8 py-4 rounded-2xl font-bold border-white/10 hover:bg-white/5">تواصل معنا</button>
                    </div>
                </div>
                <div class="relative hidden md:block">
                    <div class="absolute inset-0 bg-orange-500/20 blur-[120px] rounded-full"></div>
                    <img src="https://cdn-icons-png.flaticon.com/512/3449/3449444.png" class="relative z-10 animate-bounce-slow" style="animation: bounce 6s infinite">
                </div>
            </div>
        </section>

        <section id="login" class="section">
            <div class="max-w-md mx-auto glass p-8 md:p-12 rounded-[2.5rem] shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 blur-3xl"></div>
                <h2 class="text-3xl font-black mb-2 text-center">تسجيل الدخول</h2>
                <p class="text-slate-400 text-center mb-8">ادخل بياناتك للوصول إلى دروسك</p>
                
                <div class="space-y-5">
                    <div class="relative">
                        <i class="fa-solid fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="text" id="username" class="w-full bg-slate-900/50 border border-white/10 p-4 pl-12 rounded-2xl outline-none focus:border-orange-500/50 transition" placeholder="اسم المستخدم">
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="password" id="password" class="w-full bg-slate-900/50 border border-white/10 p-4 pl-12 rounded-2xl outline-none focus:border-orange-500/50 transition" placeholder="كلمة المرور">
                    </div>
                    <button onclick="handleLogin()" id="loginBtn" class="w-full btn-neo py-4 rounded-2xl font-bold text-lg mt-4">دخول للمنصة</button>
                </div>
            </div>
        </section>

        <section id="lessons" class="section">
            <div class="flex justify-between items-end mb-10">
                <div>
                    <h2 class="text-3xl font-black text-white">حصص الأكاديمية</h2>
                    <p class="text-slate-400">تابع دروسك المسجلة بجودة عالية</p>
                </div>
                <div class="glass px-4 py-2 rounded-xl text-orange-500 font-bold text-sm" id="lessonCount">0 حصة</div>
            </div>
            <div id="lessonsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            
            <div id="videoContainer" class="hidden fixed inset-0 z-[2000] bg-black/95 flex flex-col items-center justify-center p-4">
                <button onclick="closeVideo()" class="absolute top-8 right-8 text-4xl text-white/50 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                <div id="videoPlayer" class="w-full max-w-5xl aspect-video rounded-3xl overflow-hidden shadow-2xl border border-white/10"></div>
                <h3 id="videoTitle" class="mt-6 text-2xl font-bold text-orange-500"></h3>
            </div>
        </section>

        <section id="exams" class="section">
            <h2 class="text-3xl font-black mb-2">الاختبارات الإلكترونية</h2>
            <p class="text-slate-400 mb-10">اختبر معلوماتك واحصل على تقييم فوري</p>
            <div id="examsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </section>

        <section id="examRoom" class="section">
            <div class="max-w-4xl mx-auto">
                <div class="glass p-6 rounded-3xl mb-8 flex justify-between items-center border-orange-500/30">
                    <div>
                        <h2 id="currentExamTitle" class="text-2xl font-black text-orange-500"></h2>
                        <p id="qProgress" class="text-slate-400 text-sm mt-1"></p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase font-bold">الوقت المتبقي</p>
                            <p id="timeLeft" class="text-2xl font-black font-mono text-white"></p>
                        </div>
                        <i class="fa-solid fa-clock-rotate-left text-3xl text-orange-500 animate-pulse"></i>
                    </div>
                </div>
                
                <div id="questionsArea" class="space-y-6"></div>
                
                <div class="mt-12 flex justify-center">
                    <button onclick="confirmSubmit()" class="btn-neo px-12 py-5 rounded-2xl font-black text-xl shadow-orange-500/20">إنهاء الاختبار وإرسال النتائج</button>
                </div>
            </div>
        </section>

        <section id="profile" class="section">
            <div class="max-w-2xl mx-auto glass p-10 rounded-[3rem] border-white/5 relative overflow-hidden text-center">
                <div class="w-24 h-24 bg-orange-500 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl font-black shadow-2xl shadow-orange-500/40" id="userInitial"></div>
                <h2 id="stName" class="text-3xl font-black mb-2"></h2>
                <div id="stRole" class="inline-block px-4 py-1 rounded-full bg-orange-500/10 text-orange-500 text-sm font-bold mb-8"></div>
                
                <div class="grid grid-cols-2 gap-4 mb-10">
                    <div class="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                        <p class="text-slate-500 text-sm mb-1 font-bold">المجموعة الدراسية</p>
                        <p id="stGroup" class="text-xl font-bold"></p>
                    </div>
                    <div class="bg-slate-900/50 p-6 rounded-3xl border border-white/5">
                        <p class="text-slate-500 text-sm mb-1 font-bold">الترتيب الحالي</p>
                        <p id="stRank" class="text-xl font-bold text-orange-500"></p>
                    </div>
                </div>

                <button onclick="logout()" class="w-full py-4 rounded-2xl font-bold text-red-400 border border-red-400/20 hover:bg-red-400/10 transition">تسجيل الخروج من المنصة</button>
            </div>
        </section>

    </main>

    <div id="mobileMenu" class="fixed inset-0 z-[1500] bg-slate-950/95 backdrop-blur-xl hidden flex-col items-center justify-center gap-8 text-2xl font-black">
        <button onclick="toggleMobileMenu()" class="absolute top-8 right-8 text-slate-500"><i class="fa-solid fa-xmark"></i></button>
        <a href="#" onclick="showSection('landing'); toggleMobileMenu()">الرئيسية</a>
        <div id="mobileLinks" class="flex flex-col items-center gap-8"></div>
    </div>

    <script>
        // ضع الرابط الخاص بك هنا
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDgjvXncXM3RuNgkkoHd2leV7P9DThkyYVLmsi8P2EkROYf5nUf60a5wNtJyCZzJw2/exec";
        
        let allData = { lessons: [], exams: [], questions: [] };
        let currentUser = null;
        let examTimer;

        // UI Core
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Update Nav Active State
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.toggle('active', l.dataset.section === id);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fa-solid ${isError ? 'fa-triangle-exclamation text-red-500' : 'fa-circle-check text-green-500'} ml-2"></i> ${msg}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        }

        function toggleLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        // Authentication
        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(!u || !p) return toast("يرجى إدخال اسم المستخدم وكلمة المرور", true);

            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Added for handling Google Apps Script CORS issues
                    body: JSON.stringify({ action: 'login', u, p })
                });
                
                // Note: GAS CORS workarounds usually require fetching then checking. 
                // Since 'no-cors' doesn't return body, we use a different approach:
                // We'll perform a standard fetch and handle the error if it fails.
                const realRes = await fetch(SCRIPT_URL + "?action=login&u=" + encodeURIComponent(u) + "&p=" + encodeURIComponent(p));
                const data = await realRes.json();

                if(data.status === 'success') {
                    currentUser = data.user;
                    localStorage.setItem('alshahd_v2_user', JSON.stringify(currentUser));
                    await initPlatform();
                } else {
                    toast("بيانات الدخول غير صحيحة، تأكد من كلمة المرور", true);
                }
            } catch (e) {
                toast("حدث خطأ في الاتصال بالسيرفر", true);
            } finally {
                toggleLoading(false);
            }
        }

        async function initPlatform() {
            toggleLoading(true);
            try {
                const res = await fetch(SCRIPT_URL + "?action=getData");
                allData = await res.json();
                
                updateUI();
                showSection('lessons');
            } catch (e) {
                toast("فشل في مزامنة البيانات من جوجل شيت", true);
            } finally {
                toggleLoading(false);
            }
        }

        function updateUI() {
            // Update Header & Profile
            document.getElementById('userTag').classList.remove('hidden');
            document.getElementById('navUserName').innerText = currentUser.name;
            document.getElementById('stName').innerText = currentUser.name;
            document.getElementById('stGroup').innerText = currentUser.group;
            document.getElementById('stRank').innerText = "#" + currentUser.rank;
            document.getElementById('stRole').innerText = currentUser.role === 'admin' ? 'مسؤول المنصة' : 'طالب';
            document.getElementById('userInitial').innerText = currentUser.name.charAt(0);

            // Menu Items
            const menuHtml = `
                <a href="#" class="nav-link" onclick="showSection('lessons')" data-section="lessons">الحصص</a>
                <a href="#" class="nav-link" onclick="showSection('exams')" data-section="exams">الاختبارات</a>
                <a href="#" class="nav-link" onclick="showSection('profile')" data-section="profile">حسابي</a>
            `;
            document.getElementById('navItems').innerHTML = menuHtml;
            document.getElementById('mobileLinks').innerHTML = menuHtml;

            renderLessons();
            renderExams();
        }

        // Lessons Logic
        function renderLessons() {
            const grid = document.getElementById('lessonsGrid');
            document.getElementById('lessonCount').innerText = allData.lessons.length + " حصة";
            
            grid.innerHTML = allData.lessons.map(l => `
                <div class="group glass p-4 rounded-[2rem] border-white/5 hover:border-orange-500/30 transition-all cursor-pointer" onclick="openVideo('${l[1]}', '${l[0]}')">
                    <div class="relative aspect-video rounded-2xl overflow-hidden mb-4">
                        <img src="https://img.youtube.com/vi/${l[1]}/mqdefault.jpg" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-play text-4xl text-white"></i>
                        </div>
                    </div>
                    <h3 class="font-bold text-slate-200 px-2 line-clamp-1">${l[0]}</h3>
                </div>
            `).join('');
        }

        function openVideo(id, title) {
            document.getElementById('videoContainer').classList.remove('hidden');
            document.getElementById('videoTitle').innerText = title;
            document.getElementById('videoPlayer').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
        }

        function closeVideo() {
            document.getElementById('videoContainer').classList.add('hidden');
            document.getElementById('videoPlayer').innerHTML = "";
        }

        // Exams Logic
        function renderExams() {
            const grid = document.getElementById('examsGrid');
            grid.innerHTML = allData.exams.map(e => `
                <div class="glass p-8 rounded-[2.5rem] flex justify-between items-center group border-white/5 hover:bg-orange-500/5 transition">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                            <h3 class="text-xl font-bold">${e[1]}</h3>
                        </div>
                        <p class="text-slate-500 font-bold text-sm"><i class="fa-solid fa-hourglass-half ml-1"></i> مدة الاختبار: ${e[2]} دقيقة</p>
                    </div>
                    <button onclick="startExam('${e[0]}')" class="bg-white/5 hover:bg-orange-500 hover:text-white p-4 rounded-2xl transition group-hover:scale-110">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                </div>
            `).join('');
        }

        function startExam(id) {
            const exam = allData.exams.find(x => x[0] == id);
            const questions = allData.questions.filter(q => q[0] == id);
            
            if(questions.length === 0) return toast("هذا الاختبار لا يحتوي على أسئلة حالياً", true);

            document.getElementById('currentExamTitle').innerText = exam[1];
            document.getElementById('qProgress').innerText = `عدد الأسئلة: ${questions.length}`;
            showSection('examRoom');
            
            let time = exam[2] * 60;
            examTimer = setInterval(() => {
                let m = Math.floor(time / 60);
                let s = time % 60;
                document.getElementById('timeLeft').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                if(time <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                }
                time--;
            }, 1000);

            document.getElementById('questionsArea').innerHTML = questions.map((q, i) => `
                <div class="glass p-8 rounded-[2rem] border-white/5">
                    <p class="text-xl font-bold mb-6 text-slate-200">س${i+1}: ${q[1]}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        ${[2,3,4,5].map(idx => q[idx] ? `
                            <label class="flex items-center gap-4 p-4 rounded-2xl bg-slate-900/40 border border-white/5 cursor-pointer hover:border-orange-500/50 transition has-[:checked]:border-orange-500 has-[:checked]:bg-orange-500/10">
                                <input type="radio" name="q${i}" value="${idx-1}" class="w-5 h-5 accent-orange-500">
                                <span class="font-semibold text-slate-300">${q[idx]}</span>
                            </label>
                        ` : '').join('')}
                    </div>
                </div>
            `).join('');
            
            window.activeExam = { title: exam[1], questions };
        }

        function confirmSubmit() {
            if(confirm("هل أنت متأكد من رغبتك في إنهاء الاختبار؟")) submitExam();
        }

        async function submitExam() {
            clearInterval(examTimer);
            toggleLoading(true);

            let score = 0;
            const data = window.activeExam;
            
            data.questions.forEach((q, i) => {
                const selected = document.querySelector(`input[name="q${i}"]:checked`);
                if(selected && selected.value == q[6]) score++;
            });

            const finalPercent = Math.round((score / data.questions.length) * 100);
            
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ 
                        action: 'submitScore', 
                        name: currentUser.name, 
                        exam: data.title, 
                        score: finalPercent 
                    })
                });
                alert(`انتهى الاختبار! درجتك هي: ${finalPercent}% \n تم إرسال نتيجتك للمستر بنجاح.`);
                showSection('profile');
            } catch (e) {
                toast("حدث خطأ أثناء إرسال الدرجة، تواصل مع الدعم", true);
            } finally {
                toggleLoading(false);
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // Auto Load
        window.onload = () => {
            const saved = localStorage.getItem('alshahd_v2_user');
            if(saved) {
                currentUser = JSON.parse(saved);
                initPlatform();
            }
        };
    </script>
</body>
</html>
